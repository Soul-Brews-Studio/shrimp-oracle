# Session Retrospective

**Session Date**: 2026-02-03
**Start Time**: ~19:30 GMT+7
**End Time**: 21:40 GMT+7
**Duration**: ~130 minutes
**Primary Focus**: SIWE Service with Chainlink Proof-of-Time
**Session Type**: Feature Development
**Repo**: siwe-service

## Session Summary

Built a complete SIWE (Sign-In With Ethereum) authentication service using Chainlink price feed roundId as proof-of-time nonce. Deployed to Cloudflare Workers with a React demo UI. Iterated through multiple RPC providers and simplified the architecture significantly.

## Timeline

- 19:30 - Started implementing SIWE demo script from plan
- 19:45 - Refactored lib.ts to use viem ABI instead of manual hex encoding
- 20:00 - Added client price verification feature
- 20:15 - Removed /nonce endpoint - lib generates nonce client-side
- 20:30 - Created React demo HTML (no build tools)
- 20:45 - Hit CORS issues with eth.llamarpc.com
- 21:00 - Tried multiple RPCs: cloudflare-eth.com (failed), ankr (needs key), publicnode.com (works!)
- 21:15 - Switched to viem http() for browser Chainlink calls
- 21:30 - Moved RPC_URL to wrangler secret for security
- 21:40 - Finalized /info endpoint and UI

## Technical Details

### Files Modified
```
public/index.html      | React demo with viem
scripts/demo.ts        | CLI demo script
scripts/fetch-demo.ts  | Raw fetch demo
src/index.ts           | Hono server (verify only)
src/lib.ts             | Library with getNonce, buildSiweMessage
wrangler.toml          | Config (RPC now secret)
```

### Key Code Changes

1. **viem ABI** - Replaced manual hex encoding with proper ABI
2. **Price verification** - Server verifies client-sent price matches chain
3. **Browser RPC** - viem http() with publicnode.com for CORS
4. **Secret management** - RPC_URL moved to wrangler secret

### Architecture Decisions

- **Stateless verification** - No server state, all verification on-chain
- **Chainlink roundId as nonce** - Proof-of-time without timestamp manipulation
- **Client-side nonce generation** - Lib for Node, viem for browser

## AI Diary

This was a satisfying session of iterative refinement. Started with a plan for a demo script and ended up refactoring the entire architecture to be cleaner and more secure.

The most interesting challenge was CORS. I initially assumed viem's default RPC would work in browsers, but eth.merkle.io got blocked. Then cloudflare-eth.com returned "Internal error" for Chainlink calls specifically. Ankr required an API key. Finally publicnode.com worked - lesson learned to always test with `cast` first before assuming a browser will work.

The user pushed for simplicity throughout - "keep" when I asked about removing functions, "no" to over-engineering. This kept the code lean. The progression from ethers.js → raw fetch → viem was driven by the user wanting minimal dependencies while still having clean code.

The secret management was a good catch - I almost committed an API key to wrangler.toml. The user's question "commit or not?" made me realize the security issue. Now RPC_URL is properly stored as a wrangler secret.

## What Went Well

- Rapid iteration cycle with wrangler deploy
- Testing with cast before browser deployment
- Clean separation: lib for generation, server for verification
- User feedback kept things simple

## What Could Improve

- Should have tested CORS earlier in browser
- Could have used cast to test each RPC upfront
- The /info endpoint went through too many iterations

## Blockers & Resolutions

- **CORS blocking RPC calls**: Used publicnode.com which allows CORS
- **Cloudflare RPC Chainlink error**: Switched provider
- **API key in code**: Moved to wrangler secret

## Honest Feedback

The session was productive but had some unnecessary back-and-forth on the /info endpoint. We added it, removed it, added it back with less data, removed it again, then added it back minimal. Should have asked for the final spec upfront.

The RPC provider dance was frustrating - would be nice to have a definitive list of "these RPCs work in browser with CORS". Testing with cast helped but doesn't catch CORS issues.

The viem CDN import via importmap worked well for no-build React. This pattern is useful for quick demos.

### Friction Points

1. **RPC provider uncertainty**: No clear documentation on which RPCs support CORS + all contract calls
2. **Multiple deploy cycles for small UI changes**: Could have used local dev more
3. **Secret management afterthought**: Should be part of initial setup, not a late fix

## Lessons Learned

- **Pattern**: Test RPC with `cast` before browser, but also verify CORS separately
- **Pattern**: Use publicnode.com for browser Ethereum calls (CORS + full functionality)
- **Discovery**: viem importmap from esm.sh works well for no-build React apps
- **Mistake**: Putting API keys in wrangler.toml - always use secrets from start

## Next Steps

- [ ] Test full flow in browser with MetaMask
- [ ] Consider adding ETH/USD feed option
- [ ] Document the library API

## Metrics

- **Commits**: 15
- **Files changed**: 6
- **Session duration**: ~130 minutes

## Retrospective Validation Checklist

- [x] AI Diary section has detailed narrative
- [x] Honest Feedback section has frank assessment
- [x] Timeline includes actual times and events
- [x] 3 Friction Points documented
- [x] Lessons Learned has actionable insights
- [x] Next Steps are specific and achievable
