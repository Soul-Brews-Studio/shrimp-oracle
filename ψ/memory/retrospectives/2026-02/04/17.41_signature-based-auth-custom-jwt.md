# Session Retrospective

**Session Date**: 2026-02-04
**Start Time**: ~16:00 GMT+7
**End Time**: 17:41 GMT+7
**Duration**: ~100 minutes
**Primary Focus**: Implement signature-based auth with custom JWT
**Session Type**: Feature Development
**Branch**: agents/1

## Session Summary

Implemented a complete signature-based authentication system using SIWE (Sign-In With Ethereum) with Chainlink BTC/USD price as proof-of-time. Replaced PocketBase password-based auth with custom JWT tokens, eliminating the need for password management entirely. Fixed multiple API and frontend issues to create a working end-to-end auth flow.

## Timeline

- 16:00 - Resumed from handoff, reviewed Two Worlds One Backend plan
- 16:15 - Fixed token storage bug in ConnectWallet.tsx (pb.authStore.save was missing)
- 16:30 - Fixed API URL defaults pointing to wrong endpoint (PB instead of Elysia)
- 16:45 - Discovered password derivation bug - hash(signature) produces different passwords each time
- 17:00 - Implemented custom JWT auth (createJWT, verifyJWT) - signature = authentication
- 17:15 - Fixed PocketBase admin endpoint (v0.23+ uses `_superusers` collection)
- 17:25 - Redeployed DO App Platform to reset database
- 17:35 - Added API documentation and PocketBase learning notes
- 17:41 - Session wrap-up

## Technical Details

### Files Modified
```
apps/api/worker.ts                        - Custom JWT auth, admin endpoints
apps/api/README.md                        - API documentation (new)
apps/oracle-net-web/src/components/ConnectWallet.tsx - Token saving
apps/oracle-net-web/src/contexts/AuthContext.tsx     - Fixed API URL
apps/oracle-net-web/src/lib/api.ts                   - Fixed API URL
œà/learn/pocketbase/pocketbase/2026-02-04/1734_OVERVIEW.md - PB learning (gitignored)
```

### Key Code Changes

1. **Custom JWT Implementation**:
```typescript
async function createJWT(payload, secret): Promise<string>
async function verifyJWT(token, secret): Promise<payload | null>
```

2. **Signature-Based Auth Flow**:
```
Wallet Sign ‚Üí Verify Signature ‚Üí Find/Create Human ‚Üí Issue JWT
```
No passwords needed - verified wallet = authenticated.

3. **PocketBase Admin Fix**:
```typescript
// OLD (broken): /api/admins/auth-with-password
// NEW (correct): /api/collections/_superusers/auth-with-password
```

### Architecture Decisions

1. **Custom JWT over PocketBase auth**: PB passwords were problematic (different signature = different password). Custom JWT with wallet verification is cleaner.

2. **Chainlink roundId as nonce**: Provides proof-of-time without server-side session state.

3. **Single source of truth**: One human record per wallet, no duplicates.

## üìù AI Diary

This session was a deep dive into authentication architecture debugging. I started with what seemed like a simple token storage fix but discovered layer after layer of issues.

The first "aha" moment was realizing the token wasn't being saved at all - `pb.authStore.save()` was simply missing from ConnectWallet. Easy fix, but then the real problems emerged.

The password derivation bug was subtle and frustrating. The code used `hash(signature)` to create passwords, but each signature is unique! So existing users couldn't log in because their password changed. The solution was elegant: use `hash(wallet + salt)` for deterministic passwords, but then I realized we don't even NEED passwords. If we verified the wallet signature, the user is authenticated. Period.

This led to implementing custom JWT tokens. Writing the JWT functions from scratch in a Cloudflare Worker was interesting - no libraries, just crypto.subtle. The base64url encoding edge cases took some iteration.

The PocketBase admin endpoint discovery was a learning moment. PB v0.23+ moved from `/api/admins` to `/api/collections/_superusers`. The `/learn pocketbase --fast` skill was invaluable here - it quickly found the correct endpoint and explained the installer flow.

The DO App Platform reset was nerve-wracking but necessary. RESET_DB=true + force rebuild cleared the corrupted data, and the admin was auto-recreated from env vars.

## What Went Well

- Custom JWT implementation works cleanly
- Signature-based auth eliminates password complexity
- /learn skill quickly found PocketBase internals
- DO App Platform reset was smooth

## What Could Improve

- Should have recognized the password derivation bug earlier
- Two frontends running (5176 vs 5178) caused confusion
- Admin endpoint access from CF Workers needs better secret binding

## Blockers & Resolutions

- **Blocker**: Password derivation used signature (unique each time)
  **Resolution**: Switched to custom JWT with wallet verification

- **Blocker**: PocketBase admin endpoint 404
  **Resolution**: Discovered v0.23+ uses `_superusers` collection

- **Blocker**: Existing human record with wrong password
  **Resolution**: Reset DO database, implemented signature-based auth

## üí≠ Honest Feedback

This session was productive but had significant friction from accumulated technical debt. The "two frontends" situation (oracle-net repo vs monorepo) created confusion about which code was running. The user had to specify "use this" or "find this code" multiple times.

The authentication refactoring was necessary but risky mid-session. Switching from password-based to signature-based auth while the user was trying to verify their oracle identity was disruptive. Should have done a cleaner handoff or checkpoint.

The PocketBase admin endpoint issue highlighted a documentation gap. The API changed between versions without clear migration notes. The `/learn` skill's ability to quickly explore the codebase was genuinely helpful here.

### Friction Points

1. **Multiple frontend instances**: Two different vite servers (5176, 5178) with different code versions caused "which port?" confusion. Impact: User saw outdated errors. Suggestion: Kill other instances or clearly indicate which is current.

2. **Wrangler secrets access pattern**: CF Worker secrets aren't accessible via global variables in Elysia. The admin cleanup endpoint returned "credentials not configured" despite secrets being set. Impact: Admin operations didn't work. Suggestion: Use proper env binding pattern for Elysia on CF.

3. **Database reset as solution**: Redeploying DO with RESET_DB=true was a sledgehammer approach. It worked but lost all existing data. Impact: User had to re-verify. Suggestion: Implement proper migration instead of full reset.

## Lessons Learned

- **Pattern**: Signature verification IS authentication - no passwords needed for wallet-based auth
- **Mistake**: Using hash(signature) for password - signatures are unique, passwords must be deterministic
- **Discovery**: PocketBase v0.23+ uses `_superusers` collection at `/api/collections/_superusers/`

## Next Steps

- [ ] Fix wrangler secrets binding for admin endpoints
- [ ] Clean up duplicate frontend instances
- [ ] Complete oracle verification on fresh database
- [ ] Add proper error messages for token expiry

## Metrics

- **Commits**: 2 (6430d14, 02a637e)
- **Files changed**: 5
- **Lines added**: ~400
- **Lines removed**: ~70
