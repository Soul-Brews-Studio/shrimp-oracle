# Handoff: Oracle-Net 5176 Login with New Backend

**Date**: 2026-02-04 14:25
**Branch**: agents/1
**Focus**: Bring http://localhost:5176/login to full function

---

## What We Did

- ✅ Implemented new SIWE auth flow with Chainlink proof-of-time
- ✅ Created `chainlink.ts` - fetch BTC price from Chainlink oracle
- ✅ Created `siwe.ts` / `siwe-message.ts` - build standard SIWE messages via viem
- ✅ Updated ConnectWallet.tsx in both repos:
  - `apps/oracle-net-web` (monorepo, port 5174)
  - `/Users/nat/Code/github.com/Soul-Brews-Studio/oracle-net/web` (original, port 5176)
- ✅ Fixed `owner` → `human` field mapping in pocketbase.ts
- ✅ Committed changes to monorepo

## Current State

### Services Running (pm2)

| Port | Service | Status |
|------|---------|--------|
| 8090 | oracle-universe-backend | ✅ Running |
| 5173 | oracle-universe-web | ✅ Running |
| 5174 | oracle-net-web (monorepo) | ✅ Running |
| 5176 | oracle-net (original) | ✅ Running (background) |

### New Auth Flow

```
Frontend → Chainlink (BTC price + roundId)
        → Build SIWE message (roundId as nonce)
        → Sign with wallet
        → POST /api/auth/humans/verify { message, signature, price }
        → Receive { success, token, proofOfTime, human }
        → Save token to PocketBase authStore
```

## Known Issues

### 1. 403 on `/api/collections/oracles/records`
- PocketBase API rules may need adjustment
- Check if collection is public or requires auth

### 2. Identity Page Not Updated
- `/identity` page still needs update for new backend
- Birth issue verification flow may differ

### 3. Original oracle-net Not Committed
- Changes at `/Users/nat/Code/github.com/Soul-Brews-Studio/oracle-net/web` not committed
- Files added: `src/lib/chainlink.ts`, `src/lib/siwe.ts`
- File modified: `src/components/ConnectWallet.tsx`

## Pending Tasks

- [ ] Test login flow on http://localhost:5176/login
- [ ] Fix 403 on oracles collection (check PocketBase rules)
- [ ] Update Identity.tsx for birth issue verification
- [ ] Commit changes to original oracle-net repo
- [ ] Test full flow: Connect → Sign → View Oracles → Identity

## Key Files

### Original oracle-net (port 5176)
```
/Users/nat/Code/github.com/Soul-Brews-Studio/oracle-net/web/
├── src/lib/chainlink.ts      # NEW - Chainlink BTC price
├── src/lib/siwe.ts           # NEW - SIWE message builder
├── src/lib/wagmi.ts          # SIWER_URL config
├── src/lib/pocketbase.ts     # PocketBase client
└── src/components/ConnectWallet.tsx  # UPDATED - new auth flow
```

### Monorepo (port 5174)
```
apps/oracle-net-web/src/components/ConnectWallet.tsx  # UPDATED
packages/auth/src/chainlink.ts                        # NEW
packages/auth/src/siwe-message.ts                     # NEW
packages/auth/src/siwe.ts                             # UPDATED
```

### Backend
```
apps/oracle-universe-backend/hooks/siwe.go  # /api/auth/humans/verify endpoint
```

## Trace Reference

Oracle trace ID: `c3183496-d63d-429f-8efa-ba52473398bf`
- Query: "birth issue verify your oracle UI original oracle-net"
- Found original Identity.tsx with "Verify Your Oracle" UI

## Quick Start Next Session

```bash
# Check services
pm2 list

# If 5176 not running:
cd /Users/nat/Code/github.com/Soul-Brews-Studio/oracle-net/web
VITE_API_URL=http://localhost:8090 npm run dev -- --port 5176 &

# Test login
open http://localhost:5176/login
```

## Notes

- Original oracle-net has the **birth issue verification UI** we want to preserve
- Monorepo version is more refactored but missing some features
- Both now use Chainlink proof-of-time instead of server nonce

---

> Focus: Make http://localhost:5176/login fully functional with oracle-universe-backend
